from enmapboxprocessing.algorithm.prepareclassificationsamplefrommapandraster import \
    PrepareClassificationSampleFromMapAndRaster
from enmapboxprocessing.test.algorithm.testcase import TestCase
from enmapboxprocessing.typing import ClassifierDump
from enmapboxprocessing.utils import Utils
from enmapboxtestdata import enmap, landcover_polygons, landcover_points

writeToDisk = True
c = ['', 'c:'][int(writeToDisk)]


class TestPrepareClassificationSampleFromMapAndRaster(TestCase):

    def test_polygon(self):
        alg = PrepareClassificationSampleFromMapAndRaster()
        parameters = {
            alg.P_RASTER: enmap,
            alg.P_MAP: landcover_polygons,
            alg.P_OUTPUT_SAMPLE: c + '/vsimem/sample.pkl'
        }
        self.runalg(alg, parameters)
        dump = ClassifierDump(**Utils.pickleLoad(parameters[alg.P_OUTPUT_SAMPLE]))
        self.assertEqual((1924, 177), dump.X.shape)
        self.assertEqual((1924, 1), dump.y.shape)
        self.assertEqual(177, len(dump.features))
        self.assertEqual(
            "['Band 001: band 8 (0.460000 Micrometers)', 'Band 002: band 9 (0.465000 Micrometers)', 'Band 003: band 10 (0.470000 Micrometers)', 'Band 004: band 11 (0.475000 Micrometers)', 'Band 005: band 12 (0.479000 Micrometers)', 'Band 006: band 13 (0.484000 Micrometers)', 'Band 007: band 14 (0.489000 Micrometers)', 'Band 008: band 15 (0.494000 Micrometers)', 'Band 009: band 16 (0.499000 Micrometers)', 'Band 010: band 17 (0.503000 Micrometers)', 'Band 011: band 18 (0.508000 Micrometers)', 'Band 012: band 19 (0.513000 Micrometers)', 'Band 013: band 20 (0.518000 Micrometers)', 'Band 014: band 21 (0.523000 Micrometers)', 'Band 015: band 22 (0.528000 Micrometers)', 'Band 016: band 23 (0.533000 Micrometers)', 'Band 017: band 24 (0.538000 Micrometers)', 'Band 018: band 25 (0.543000 Micrometers)', 'Band 019: band 26 (0.549000 Micrometers)', 'Band 020: band 27 (0.554000 Micrometers)', 'Band 021: band 28 (0.559000 Micrometers)', 'Band 022: band 29 (0.565000 Micrometers)', 'Band 023: band 30 (0.570000 Micrometers)', 'Band 024: band 31 (0.575000 Micrometers)', 'Band 025: band 32 (0.581000 Micrometers)', 'Band 026: band 33 (0.587000 Micrometers)', 'Band 027: band 34 (0.592000 Micrometers)', 'Band 028: band 35 (0.598000 Micrometers)', 'Band 029: band 36 (0.604000 Micrometers)', 'Band 030: band 37 (0.610000 Micrometers)', 'Band 031: band 38 (0.616000 Micrometers)', 'Band 032: band 39 (0.622000 Micrometers)', 'Band 033: band 40 (0.628000 Micrometers)', 'Band 034: band 41 (0.634000 Micrometers)', 'Band 035: band 42 (0.640000 Micrometers)', 'Band 036: band 43 (0.646000 Micrometers)', 'Band 037: band 44 (0.653000 Micrometers)', 'Band 038: band 45 (0.659000 Micrometers)', 'Band 039: band 46 (0.665000 Micrometers)', 'Band 040: band 47 (0.672000 Micrometers)', 'Band 041: band 48 (0.679000 Micrometers)', 'Band 042: band 49 (0.685000 Micrometers)', 'Band 043: band 50 (0.692000 Micrometers)', 'Band 044: band 51 (0.699000 Micrometers)', 'Band 045: band 52 (0.706000 Micrometers)', 'Band 046: band 53 (0.713000 Micrometers)', 'Band 047: band 54 (0.720000 Micrometers)', 'Band 048: band 55 (0.727000 Micrometers)', 'Band 049: band 56 (0.734000 Micrometers)', 'Band 050: band 57 (0.741000 Micrometers)', 'Band 051: band 58 (0.749000 Micrometers)', 'Band 052: band 59 (0.756000 Micrometers)', 'Band 053: band 60 (0.763000 Micrometers)', 'Band 054: band 61 (0.771000 Micrometers)', 'Band 055: band 62 (0.778000 Micrometers)', 'Band 056: band 63 (0.786000 Micrometers)', 'Band 057: band 64 (0.793000 Micrometers)', 'Band 058: band 65 (0.801000 Micrometers)', 'Band 059: band 66 (0.809000 Micrometers)', 'Band 060: band 67 (0.817000 Micrometers)', 'Band 061: band 68 (0.824000 Micrometers)', 'Band 062: band 69 (0.832000 Micrometers)', 'Band 063: band 70 (0.840000 Micrometers)', 'Band 064: band 71 (0.848000 Micrometers)', 'Band 065: band 72 (0.856000 Micrometers)', 'Band 066: band 73 (0.864000 Micrometers)', 'Band 067: band 74 (0.872000 Micrometers)', 'Band 068: band 75 (0.880000 Micrometers)', 'Band 069: band 76 (0.888000 Micrometers)', 'Band 070: band 77 (0.896000 Micrometers)', 'Band 071: band 91 (0.915000 Micrometers)', 'Band 072: band 92 (0.924000 Micrometers)', 'Band 073: band 93 (0.934000 Micrometers)', 'Band 074: band 94 (0.944000 Micrometers)', 'Band 075: band 95 (0.955000 Micrometers)', 'Band 076: band 96 (0.965000 Micrometers)', 'Band 077: band 97 (0.975000 Micrometers)', 'Band 078: band 98 (0.986000 Micrometers)', 'Band 079: band 99 (0.997000 Micrometers)', 'Band 080: band 100 (1.007000 Micrometers)', 'Band 081: band 101 (1.018000 Micrometers)', 'Band 082: band 102 (1.029000 Micrometers)', 'Band 083: band 103 (1.040000 Micrometers)', 'Band 084: band 104 (1.051000 Micrometers)', 'Band 085: band 105 (1.063000 Micrometers)', 'Band 086: band 106 (1.074000 Micrometers)', 'Band 087: band 107 (1.086000 Micrometers)', 'Band 088: band 108 (1.097000 Micrometers)', 'Band 089: band 109 (1.109000 Micrometers)', 'Band 090: band 110 (1.120000 Micrometers)', 'Band 091: band 111 (1.132000 Micrometers)', 'Band 092: band 112 (1.144000 Micrometers)', 'Band 093: band 113 (1.155000 Micrometers)', 'Band 094: band 114 (1.167000 Micrometers)', 'Band 095: band 115 (1.179000 Micrometers)', 'Band 096: band 116 (1.191000 Micrometers)', 'Band 097: band 117 (1.203000 Micrometers)', 'Band 098: band 118 (1.215000 Micrometers)', 'Band 099: band 119 (1.227000 Micrometers)', 'Band 100: band 120 (1.239000 Micrometers)', 'Band 101: band 121 (1.251000 Micrometers)', 'Band 102: band 122 (1.263000 Micrometers)', 'Band 103: band 123 (1.275000 Micrometers)', 'Band 104: band 124 (1.287000 Micrometers)', 'Band 105: band 125 (1.299000 Micrometers)', 'Band 106: band 126 (1.311000 Micrometers)', 'Band 107: band 127 (1.323000 Micrometers)', 'Band 108: band 144 (1.522000 Micrometers)', 'Band 109: band 145 (1.534000 Micrometers)', 'Band 110: band 146 (1.545000 Micrometers)', 'Band 111: band 147 (1.557000 Micrometers)', 'Band 112: band 148 (1.568000 Micrometers)', 'Band 113: band 149 (1.579000 Micrometers)', 'Band 114: band 150 (1.590000 Micrometers)', 'Band 115: band 151 (1.601000 Micrometers)', 'Band 116: band 152 (1.612000 Micrometers)', 'Band 117: band 153 (1.624000 Micrometers)', 'Band 118: band 154 (1.634000 Micrometers)', 'Band 119: band 155 (1.645000 Micrometers)', 'Band 120: band 156 (1.656000 Micrometers)', 'Band 121: band 157 (1.667000 Micrometers)', 'Band 122: band 158 (1.678000 Micrometers)', 'Band 123: band 159 (1.689000 Micrometers)', 'Band 124: band 160 (1.699000 Micrometers)', 'Band 125: band 161 (1.710000 Micrometers)', 'Band 126: band 162 (1.721000 Micrometers)', 'Band 127: band 163 (1.731000 Micrometers)', 'Band 128: band 164 (1.742000 Micrometers)', 'Band 129: band 165 (1.752000 Micrometers)', 'Band 130: band 166 (1.763000 Micrometers)', 'Band 131: band 167 (1.773000 Micrometers)', 'Band 132: band 168 (1.783000 Micrometers)', 'Band 133: band 195 (2.044000 Micrometers)', 'Band 134: band 196 (2.053000 Micrometers)', 'Band 135: band 197 (2.062000 Micrometers)', 'Band 136: band 198 (2.071000 Micrometers)', 'Band 137: band 199 (2.080000 Micrometers)', 'Band 138: band 200 (2.089000 Micrometers)', 'Band 139: band 201 (2.098000 Micrometers)', 'Band 140: band 202 (2.107000 Micrometers)', 'Band 141: band 203 (2.115000 Micrometers)', 'Band 142: band 204 (2.124000 Micrometers)', 'Band 143: band 205 (2.133000 Micrometers)', 'Band 144: band 206 (2.141000 Micrometers)', 'Band 145: band 207 (2.150000 Micrometers)', 'Band 146: band 208 (2.159000 Micrometers)', 'Band 147: band 209 (2.167000 Micrometers)', 'Band 148: band 210 (2.176000 Micrometers)', 'Band 149: band 211 (2.184000 Micrometers)', 'Band 150: band 212 (2.193000 Micrometers)', 'Band 151: band 213 (2.201000 Micrometers)', 'Band 152: band 214 (2.210000 Micrometers)', 'Band 153: band 215 (2.218000 Micrometers)', 'Band 154: band 216 (2.226000 Micrometers)', 'Band 155: band 217 (2.234000 Micrometers)', 'Band 156: band 218 (2.243000 Micrometers)', 'Band 157: band 219 (2.251000 Micrometers)', 'Band 158: band 220 (2.259000 Micrometers)', 'Band 159: band 221 (2.267000 Micrometers)', 'Band 160: band 222 (2.275000 Micrometers)', 'Band 161: band 223 (2.283000 Micrometers)', 'Band 162: band 224 (2.292000 Micrometers)', 'Band 163: band 225 (2.300000 Micrometers)', 'Band 164: band 226 (2.308000 Micrometers)', 'Band 165: band 227 (2.315000 Micrometers)', 'Band 166: band 228 (2.323000 Micrometers)', 'Band 167: band 229 (2.331000 Micrometers)', 'Band 168: band 230 (2.339000 Micrometers)', 'Band 169: band 231 (2.347000 Micrometers)', 'Band 170: band 232 (2.355000 Micrometers)', 'Band 171: band 233 (2.363000 Micrometers)', 'Band 172: band 234 (2.370000 Micrometers)', 'Band 173: band 235 (2.378000 Micrometers)', 'Band 174: band 236 (2.386000 Micrometers)', 'Band 175: band 237 (2.393000 Micrometers)', 'Band 176: band 238 (2.401000 Micrometers)', 'Band 177: band 239 (2.409000 Micrometers)']",
            str(dump.features)
        )
        self.assertEqual(
            "[Category(value=1, name='roof', color='#e60000'), Category(value=2, name='pavement', color='#9c9c9c'), Category(value=3, name='low vegetation', color='#98e600'), Category(value=4, name='tree', color='#267300'), Category(value=5, name='soil', color='#a87000'), Category(value=6, name='water', color='#0064ff')]",
            str(dump.categories)
        )

    def test_points(self):
        alg = PrepareClassificationSampleFromMapAndRaster()
        parameters = {
            alg.P_RASTER: enmap,
            alg.P_MAP: landcover_points,
            alg.P_OUTPUT_SAMPLE: c + '/vsimem/sample.pkl'
        }
        self.runalg(alg, parameters)
        dump = ClassifierDump(**Utils.pickleLoad(parameters[alg.P_OUTPUT_SAMPLE]))
        self.assertEqual((58, 177), dump.X.shape)
        self.assertEqual((58, 1), dump.y.shape)
        self.assertEqual(177, len(dump.features))
        self.assertEqual(
            "['Band 001: band 8 (0.460000 Micrometers)', 'Band 002: band 9 (0.465000 Micrometers)', 'Band 003: band 10 (0.470000 Micrometers)', 'Band 004: band 11 (0.475000 Micrometers)', 'Band 005: band 12 (0.479000 Micrometers)', 'Band 006: band 13 (0.484000 Micrometers)', 'Band 007: band 14 (0.489000 Micrometers)', 'Band 008: band 15 (0.494000 Micrometers)', 'Band 009: band 16 (0.499000 Micrometers)', 'Band 010: band 17 (0.503000 Micrometers)', 'Band 011: band 18 (0.508000 Micrometers)', 'Band 012: band 19 (0.513000 Micrometers)', 'Band 013: band 20 (0.518000 Micrometers)', 'Band 014: band 21 (0.523000 Micrometers)', 'Band 015: band 22 (0.528000 Micrometers)', 'Band 016: band 23 (0.533000 Micrometers)', 'Band 017: band 24 (0.538000 Micrometers)', 'Band 018: band 25 (0.543000 Micrometers)', 'Band 019: band 26 (0.549000 Micrometers)', 'Band 020: band 27 (0.554000 Micrometers)', 'Band 021: band 28 (0.559000 Micrometers)', 'Band 022: band 29 (0.565000 Micrometers)', 'Band 023: band 30 (0.570000 Micrometers)', 'Band 024: band 31 (0.575000 Micrometers)', 'Band 025: band 32 (0.581000 Micrometers)', 'Band 026: band 33 (0.587000 Micrometers)', 'Band 027: band 34 (0.592000 Micrometers)', 'Band 028: band 35 (0.598000 Micrometers)', 'Band 029: band 36 (0.604000 Micrometers)', 'Band 030: band 37 (0.610000 Micrometers)', 'Band 031: band 38 (0.616000 Micrometers)', 'Band 032: band 39 (0.622000 Micrometers)', 'Band 033: band 40 (0.628000 Micrometers)', 'Band 034: band 41 (0.634000 Micrometers)', 'Band 035: band 42 (0.640000 Micrometers)', 'Band 036: band 43 (0.646000 Micrometers)', 'Band 037: band 44 (0.653000 Micrometers)', 'Band 038: band 45 (0.659000 Micrometers)', 'Band 039: band 46 (0.665000 Micrometers)', 'Band 040: band 47 (0.672000 Micrometers)', 'Band 041: band 48 (0.679000 Micrometers)', 'Band 042: band 49 (0.685000 Micrometers)', 'Band 043: band 50 (0.692000 Micrometers)', 'Band 044: band 51 (0.699000 Micrometers)', 'Band 045: band 52 (0.706000 Micrometers)', 'Band 046: band 53 (0.713000 Micrometers)', 'Band 047: band 54 (0.720000 Micrometers)', 'Band 048: band 55 (0.727000 Micrometers)', 'Band 049: band 56 (0.734000 Micrometers)', 'Band 050: band 57 (0.741000 Micrometers)', 'Band 051: band 58 (0.749000 Micrometers)', 'Band 052: band 59 (0.756000 Micrometers)', 'Band 053: band 60 (0.763000 Micrometers)', 'Band 054: band 61 (0.771000 Micrometers)', 'Band 055: band 62 (0.778000 Micrometers)', 'Band 056: band 63 (0.786000 Micrometers)', 'Band 057: band 64 (0.793000 Micrometers)', 'Band 058: band 65 (0.801000 Micrometers)', 'Band 059: band 66 (0.809000 Micrometers)', 'Band 060: band 67 (0.817000 Micrometers)', 'Band 061: band 68 (0.824000 Micrometers)', 'Band 062: band 69 (0.832000 Micrometers)', 'Band 063: band 70 (0.840000 Micrometers)', 'Band 064: band 71 (0.848000 Micrometers)', 'Band 065: band 72 (0.856000 Micrometers)', 'Band 066: band 73 (0.864000 Micrometers)', 'Band 067: band 74 (0.872000 Micrometers)', 'Band 068: band 75 (0.880000 Micrometers)', 'Band 069: band 76 (0.888000 Micrometers)', 'Band 070: band 77 (0.896000 Micrometers)', 'Band 071: band 91 (0.915000 Micrometers)', 'Band 072: band 92 (0.924000 Micrometers)', 'Band 073: band 93 (0.934000 Micrometers)', 'Band 074: band 94 (0.944000 Micrometers)', 'Band 075: band 95 (0.955000 Micrometers)', 'Band 076: band 96 (0.965000 Micrometers)', 'Band 077: band 97 (0.975000 Micrometers)', 'Band 078: band 98 (0.986000 Micrometers)', 'Band 079: band 99 (0.997000 Micrometers)', 'Band 080: band 100 (1.007000 Micrometers)', 'Band 081: band 101 (1.018000 Micrometers)', 'Band 082: band 102 (1.029000 Micrometers)', 'Band 083: band 103 (1.040000 Micrometers)', 'Band 084: band 104 (1.051000 Micrometers)', 'Band 085: band 105 (1.063000 Micrometers)', 'Band 086: band 106 (1.074000 Micrometers)', 'Band 087: band 107 (1.086000 Micrometers)', 'Band 088: band 108 (1.097000 Micrometers)', 'Band 089: band 109 (1.109000 Micrometers)', 'Band 090: band 110 (1.120000 Micrometers)', 'Band 091: band 111 (1.132000 Micrometers)', 'Band 092: band 112 (1.144000 Micrometers)', 'Band 093: band 113 (1.155000 Micrometers)', 'Band 094: band 114 (1.167000 Micrometers)', 'Band 095: band 115 (1.179000 Micrometers)', 'Band 096: band 116 (1.191000 Micrometers)', 'Band 097: band 117 (1.203000 Micrometers)', 'Band 098: band 118 (1.215000 Micrometers)', 'Band 099: band 119 (1.227000 Micrometers)', 'Band 100: band 120 (1.239000 Micrometers)', 'Band 101: band 121 (1.251000 Micrometers)', 'Band 102: band 122 (1.263000 Micrometers)', 'Band 103: band 123 (1.275000 Micrometers)', 'Band 104: band 124 (1.287000 Micrometers)', 'Band 105: band 125 (1.299000 Micrometers)', 'Band 106: band 126 (1.311000 Micrometers)', 'Band 107: band 127 (1.323000 Micrometers)', 'Band 108: band 144 (1.522000 Micrometers)', 'Band 109: band 145 (1.534000 Micrometers)', 'Band 110: band 146 (1.545000 Micrometers)', 'Band 111: band 147 (1.557000 Micrometers)', 'Band 112: band 148 (1.568000 Micrometers)', 'Band 113: band 149 (1.579000 Micrometers)', 'Band 114: band 150 (1.590000 Micrometers)', 'Band 115: band 151 (1.601000 Micrometers)', 'Band 116: band 152 (1.612000 Micrometers)', 'Band 117: band 153 (1.624000 Micrometers)', 'Band 118: band 154 (1.634000 Micrometers)', 'Band 119: band 155 (1.645000 Micrometers)', 'Band 120: band 156 (1.656000 Micrometers)', 'Band 121: band 157 (1.667000 Micrometers)', 'Band 122: band 158 (1.678000 Micrometers)', 'Band 123: band 159 (1.689000 Micrometers)', 'Band 124: band 160 (1.699000 Micrometers)', 'Band 125: band 161 (1.710000 Micrometers)', 'Band 126: band 162 (1.721000 Micrometers)', 'Band 127: band 163 (1.731000 Micrometers)', 'Band 128: band 164 (1.742000 Micrometers)', 'Band 129: band 165 (1.752000 Micrometers)', 'Band 130: band 166 (1.763000 Micrometers)', 'Band 131: band 167 (1.773000 Micrometers)', 'Band 132: band 168 (1.783000 Micrometers)', 'Band 133: band 195 (2.044000 Micrometers)', 'Band 134: band 196 (2.053000 Micrometers)', 'Band 135: band 197 (2.062000 Micrometers)', 'Band 136: band 198 (2.071000 Micrometers)', 'Band 137: band 199 (2.080000 Micrometers)', 'Band 138: band 200 (2.089000 Micrometers)', 'Band 139: band 201 (2.098000 Micrometers)', 'Band 140: band 202 (2.107000 Micrometers)', 'Band 141: band 203 (2.115000 Micrometers)', 'Band 142: band 204 (2.124000 Micrometers)', 'Band 143: band 205 (2.133000 Micrometers)', 'Band 144: band 206 (2.141000 Micrometers)', 'Band 145: band 207 (2.150000 Micrometers)', 'Band 146: band 208 (2.159000 Micrometers)', 'Band 147: band 209 (2.167000 Micrometers)', 'Band 148: band 210 (2.176000 Micrometers)', 'Band 149: band 211 (2.184000 Micrometers)', 'Band 150: band 212 (2.193000 Micrometers)', 'Band 151: band 213 (2.201000 Micrometers)', 'Band 152: band 214 (2.210000 Micrometers)', 'Band 153: band 215 (2.218000 Micrometers)', 'Band 154: band 216 (2.226000 Micrometers)', 'Band 155: band 217 (2.234000 Micrometers)', 'Band 156: band 218 (2.243000 Micrometers)', 'Band 157: band 219 (2.251000 Micrometers)', 'Band 158: band 220 (2.259000 Micrometers)', 'Band 159: band 221 (2.267000 Micrometers)', 'Band 160: band 222 (2.275000 Micrometers)', 'Band 161: band 223 (2.283000 Micrometers)', 'Band 162: band 224 (2.292000 Micrometers)', 'Band 163: band 225 (2.300000 Micrometers)', 'Band 164: band 226 (2.308000 Micrometers)', 'Band 165: band 227 (2.315000 Micrometers)', 'Band 166: band 228 (2.323000 Micrometers)', 'Band 167: band 229 (2.331000 Micrometers)', 'Band 168: band 230 (2.339000 Micrometers)', 'Band 169: band 231 (2.347000 Micrometers)', 'Band 170: band 232 (2.355000 Micrometers)', 'Band 171: band 233 (2.363000 Micrometers)', 'Band 172: band 234 (2.370000 Micrometers)', 'Band 173: band 235 (2.378000 Micrometers)', 'Band 174: band 236 (2.386000 Micrometers)', 'Band 175: band 237 (2.393000 Micrometers)', 'Band 176: band 238 (2.401000 Micrometers)', 'Band 177: band 239 (2.409000 Micrometers)']",
            str(dump.features)
        )
        self.assertEqual(
            "[Category(value=1, name='impervious', color='#e60000'), Category(value=2, name='low vegetation', color='#98e600'), Category(value=3, name='tree', color='#267300'), Category(value=4, name='soil', color='#a87000'), Category(value=5, name='water', color='#0064ff')]",
            str(dump.categories)
        )
