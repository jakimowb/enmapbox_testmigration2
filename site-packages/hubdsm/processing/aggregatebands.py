from collections import OrderedDict

import numpy as np

from hubdsm.algorithm.aggregatebands import aggregateBands
from hubdsm.core.raster import Raster
from hubdsm.processing.enmapalgorithm import *


class AggregateBands(EnMAPAlgorithm):
    def displayName(self):
        return 'Aggregate Raster Bands'

    def description(self):
        return 'Aggregate multiband raster into singleband raster.'

    def group(self):
        return Group.Auxilliary.value

    P_RASTER = 'raster'
    P_FUNCTION = 'function'
    P_OUTPUT_RASTER = 'outraster'

    p5 = lambda array, axis: np.percentile(array, 5, axis)
    p25 = lambda array, axis: np.percentile(array, 25, axis)
    p75 = lambda array, axis: np.percentile(array, 75, axis)
    p95 = lambda array, axis: np.percentile(array, 95, axis)
    iqr = lambda array, axis: np.subtract(*np.percentile(array, [75, 25], axis))

    FUNCTIONS = OrderedDict(
        mean=np.mean,
        std=np.std,
        min=np.min,
        p5=p5,
        p25=p25,
        median=np.median,
        p75=p75,
        p95=p95,
        max=np.max,
        sum=np.sum,
        product=np.product,
        range=np.ptp, # The name of the function comes from the acronym for ‘peak to peak’.
        iqr=iqr,
        any=np.any,
        all=np.all
    )

    def defineCharacteristics(self):

        self.addParameter(
            EnMAPProcessingParameterRasterLayer(
                name=self.P_RASTER, description='Raster')
        )

        self.addParameter(
            EnMAPProcessingParameterEnum(
                name=self.P_FUNCTION, description='Aggregation function', options=list(self.FUNCTIONS.keys()))
        )

        self.addParameter(
            EnMAPProcessingParameterRasterDestination(
                name=self.P_OUTPUT_RASTER, description='Output Raster'
            )
        )

    def processAlgorithm_(self, parameters: Dict, context: QgsProcessingContext, feedback: QgsProcessingFeedback):

        qgsRasterLayer: QgsRasterLayer = self.parameter(parameters, self.P_RASTER, context)
        raster = Raster.open(qgsRasterLayer.source())
        aggregationFunctionSelection = self.parameter(parameters, self.P_FUNCTION, context)
        aggregationFunction = list(self.FUNCTIONS.values())[int(aggregationFunctionSelection)]
        filename = self.parameter(parameters, self.P_OUTPUT_RASTER, context)
        outraster = aggregateBands(raster=raster, aggregationFunction=aggregationFunction, filename=filename)
        return {self.P_OUTPUT_RASTER: filename}
